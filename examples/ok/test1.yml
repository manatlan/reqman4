root: http://test

i: 77

mymethod: |
  import jwt                # it works !
  assert ENV                # ENV is here !
  return x * 23

scenar1:
  - GET: /test?json=[1,2,{"key":"val"}]
    doc: test
    tests:
      - R.status == 200
      - len(R.json) == 3
      - R.json[0] == 1
      - R.json[1] == 2
      - R.json[2].key == "val"

scenar2:

  - CALL: scenar1

  - GET: /test
    doc: test
    tests:
      - R.status == 200
      
  - GET: /test?json={ "coco":"VAL" }
    doc: test
    tests:
      - R.status == 200
      - R.json.coco == "VAL"
  - SET:
       toto: <<R.json.coco>>

tata: 123

RUN:
  - SET:
      toto: 42
      KOKO: <<mymethod( 42 )>>

  - GET: /404
    doc: test NF
    tests:
      - R.status == 404
      - R.text == "Not Found"
      - R.content == b"Not Found"

  - CALL: scenar1
    params:
      - i: 1
      - i: 2
      - i: 3
    
  - SET:
      HELLO: JE SUIS LA

  - CALL: scenar2

  - SET:
      toto: 42  # need to override toto (was VAL)

  - GET: /test?json=[<<mymethod(toto) * 3>>,<<j>>]
    doc: test <<toto>>
    tests:
      - R.status == 200
      - R.headers["content-type"] == "application/json"
      - R.headers["content-TYPE"] == "application/json"
      - R.headers.content_type == "application/json"  # can't work
      - R.json[0] == 2898
      - R.json[1] == j
      - HELLO == "JE SUIS LA"
    params:
      - j: 1
      - j: 2
      - j: 3

  - SET:
       lastStatus: <<R.status>>

  